/*! 
 * Table Manager v0.0.1 - 10/11/2025
 * Copyright (c) 2025 Ali Musthofa (https://github.com/alicom13/table-manager)
 * Licensed under MIT http://www.opensource.org/licenses/MIT
 */
class TableManager{constructor(t){this.init=this.init.bind(this),this.loadData=this.loadData.bind(this),this.apiRequest=this.apiRequest.bind(this),this.handleError=this.handleError.bind(this),this.renderTable=this.renderTable.bind(this),this.handleSearch=this.handleSearch.bind(this),this.handleSort=this.handleSort.bind(this),this.toggleSelectAll=this.toggleSelectAll.bind(this),this.toggleRowSelection=this.toggleRowSelection.bind(this),this.updateSelectionCount=this.updateSelectionCount.bind(this),this.selectAllVisible=this.selectAllVisible.bind(this),this.deselectAll=this.deselectAll.bind(this),this.exportToCSV=this.exportToCSV.bind(this),this.exportToExcel=this.exportToExcel.bind(this),this.handleExport=this.handleExport.bind(this),this.showDetailModal=this.showDetailModal.bind(this),this.showEditModal=this.showEditModal.bind(this),this.showDeleteModal=this.showDeleteModal.bind(this),this.saveEdit=this.saveEdit.bind(this),this.deleteItem=this.deleteItem.bind(this),this.showCreateModal=this.showCreateModal.bind(this),this.saveCreate=this.saveCreate.bind(this),this.generateCreateForm=this.generateCreateForm.bind(this),this.generateEditForm=this.generateEditForm.bind(this),this.generateDetailContent=this.generateDetailContent.bind(this),this.getCurrentPageData=this.getCurrentPageData.bind(this),this.updatePagination=this.updatePagination.bind(this),this.showLoading=this.showLoading.bind(this),this.showNotification=this.showNotification.bind(this),this.loadExcelLibrary=this.loadExcelLibrary.bind(this),this.bindEvents=this.bindEvents.bind(this),this.generateHTMLStructure=this.generateHTMLStructure.bind(this),this.getHTMLTemplate=this.getHTMLTemplate.bind(this),this.getModalTemplates=this.getModalTemplates.bind(this),this.updateTableHeader=this.updateTableHeader.bind(this),this.getColumnCount=this.getColumnCount.bind(this),this.getCellValue=this.getCellValue.bind(this),this.getActionButtons=this.getActionButtons.bind(this),this.updateSelectAllCheckbox=this.updateSelectAllCheckbox.bind(this),this.updateSortIndicator=this.updateSortIndicator.bind(this),this.defaultConfig={tableId:"bigTable",containerId:"tableContainer",baseURL:window.location.origin,apiEndpoints:{list:"/api/data",detail:"/api/data/",create:"/api/data",update:"/api/data/",delete:"/api/data/"},pageSize:25,enableSelection:!0,enableExport:!0,enableRealTime:!1,enableCreate:!1,enableEdit:!1,enableDelete:!1,columns:[{key:"id",title:"ID",sortable:!0,visible:!0},{key:"name",title:"Nama",sortable:!0,visible:!0},{key:"email",title:"Email",sortable:!0,visible:!0},{key:"actions",title:"Aksi",sortable:!1,visible:!0}],actions:{detail:!0,edit:!1,delete:!1},requestHeaders:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},dataTransformer:null,errorHandler:null},this.config={...this.defaultConfig,...t},this.initializeProperties(),this.init()}initializeProperties(){this.currentData=[],this.filteredData=[],this.currentPage=1,this.pageSize=this.config.pageSize,this.isRealTimeActive=!1,this.ws=null,this.selectedIds=new Set,this.isSelectAll=!1,this.currentEditId=null,this.currentDeleteId=null,this.currentCreateData=null,this.currentSortField=null,this.sortDirection="asc",this.isLoading=!1,this.callbacks={onLoad:this.config.onLoad||(()=>{}),onCreate:this.config.onCreate||(()=>{}),onEdit:this.config.onEdit||(()=>{}),onDelete:this.config.onDelete||(()=>{}),onSelect:this.config.onSelect||(()=>{}),onExport:this.config.onExport||(()=>{}),onError:this.config.onError||(()=>{})}}init(){try{this.generateHTMLStructure(),this.bindEvents(),this.loadExcelLibrary(),this.config.apiEndpoints.list&&this.loadData()}catch(t){console.error("Error initializing TableManager:",t),this.handleError("Gagal menginisialisasi tabel",t)}}async apiRequest(t,e={}){try{const i={headers:this.config.requestHeaders,credentials:"same-origin"},a={...i,...e,headers:{...i.headers,...e.headers}},n=await fetch(t,a);if(!n.ok)throw new Error("HTTP error! status: "+n.status);const s=n.headers.get("content-type");return s&&s.includes("application/json")?await n.json():await n.text()}catch(t){throw this.handleError("API Request failed:",t),t}}async loadData(){if(!this.isLoading)try{this.isLoading=!0,this.showLoading(!0);const t=await this.apiRequest(this.config.apiEndpoints.list);let e=t;if(this.config.dataTransformer&&"function"==typeof this.config.dataTransformer&&(e=this.config.dataTransformer(t)),Array.isArray(e))this.currentData=e;else if(e&&Array.isArray(e.data))this.currentData=e.data;else{if(!(e&&e.success&&Array.isArray(e.data)))throw new Error("Invalid data format received from API");this.currentData=e.data}this.filteredData=[...this.currentData],this.renderTable(),this.currentData.length>0?this.showNotification(this.currentData.length+" data berhasil dimuat","success"):this.showNotification("Tidak ada data yang ditemukan","warning"),this.callbacks.onLoad(this.currentData)}catch(t){this.handleError("Gagal memuat data",t)}finally{this.isLoading=!1,this.showLoading(!1)}}handleError(t,e){if(console.error(t,e),this.config.errorHandler&&"function"==typeof this.config.errorHandler)this.config.errorHandler(e);else{const i=e.message||"Terjadi kesalahan";this.showNotification(`${t}: ${i}`,"error")}this.callbacks.onError(e)}generateHTMLStructure(){const t=document.getElementById(this.config.containerId);t?(t.innerHTML=this.getHTMLTemplate(),this.updateTableHeader()):console.error(`Container with ID '${this.config.containerId}' not found`)}getHTMLTemplate(){const t=this.config.enableSelection,e=this.config.enableExport,i=this.config.enableCreate;return`\n            <div class="table-manager-container">\n                <div id="${this.config.containerId}-notifications"></div>\n\n                <div class="row mb-3">\n                    <div class="col-md-4">\n                        <div class="input-group">\n                            <input type="text" \n                                   id="${this.config.containerId}-searchInput" \n                                   class="form-control" \n                                   placeholder="Cari data...">\n                            <button class="btn btn-outline-secondary" type="button" id="${this.config.containerId}-refreshBtn">\n                                <i class="fas fa-sync-alt"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    ${t?`\n                    <div class="col-md-4">\n                        <div class="btn-group">\n                            <button id="${this.config.containerId}-selectAllBtn" class="btn btn-outline-primary btn-sm">\n                                Pilih Semua\n                            </button>\n                            <button id="${this.config.containerId}-deselectAllBtn" class="btn btn-outline-secondary btn-sm">\n                                Batal Pilih\n                            </button>\n                            <span id="${this.config.containerId}-selectedCount" class="badge bg-primary ms-2 align-middle" style="display: none;"></span>\n                        </div>\n                    </div>\n                    `:""}\n\n                    <div class="col-md-4 text-end">\n                        ${i?`\n                        <button id="${this.config.containerId}-createBtn" class="btn btn-primary btn-sm me-2">\n                            <i class="fas fa-plus"></i> Tambah Data\n                        </button>\n                        `:""}\n                        \n                        ${e?`\n                        <div class="dropdown d-inline-block">\n                            <button class="btn btn-success dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown">\n                                <i class="fas fa-download"></i> Export\n                            </button>\n                            <ul class="dropdown-menu">\n                                <li><a class="dropdown-item export-btn" href="#" data-format="csv" data-scope="all">Export Semua ke CSV</a></li>\n                                <li><a class="dropdown-item export-btn" href="#" data-format="xlsx" data-scope="all">Export Semua ke Excel</a></li>\n                                ${t?'\n                                <li><hr class="dropdown-divider"></li>\n                                <li><a class="dropdown-item export-btn" href="#" data-format="csv" data-scope="selected">Export Terpilih ke CSV</a></li>\n                                <li><a class="dropdown-item export-btn" href="#" data-format="xlsx" data-scope="selected">Export Terpilih ke Excel</a></li>\n                                ':""}\n                            </ul>\n                        </div>\n                        `:""}\n                    </div>\n                </div>\n\n                <div class="table-responsive">\n                    <table id="${this.config.tableId}" class="table table-striped table-bordered">\n                        <thead>\n                            <tr></tr>\n                        </thead>\n                        <tbody id="${this.config.tableId}-body"></tbody>\n                    </table>\n                </div>\n\n                <div class="row mt-3">\n                    <div class="col-md-6">\n                        <div class="btn-group">\n                            <button id="${this.config.containerId}-prevBtn" class="btn btn-outline-primary btn-sm" disabled>\n                                <i class="fas fa-chevron-left"></i> Previous\n                            </button>\n                            <span id="${this.config.containerId}-pageInfo" class="mx-2 align-middle">Halaman 1 dari 1</span>\n                            <button id="${this.config.containerId}-nextBtn" class="btn btn-outline-primary btn-sm" disabled>\n                                Next <i class="fas fa-chevron-right"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="col-md-6 text-end">\n                        <select id="${this.config.containerId}-pageSize" class="form-select form-select-sm d-inline-block w-auto">\n                            <option value="10">10 per halaman</option>\n                            <option value="25" selected>25 per halaman</option>\n                            <option value="50">50 per halaman</option>\n                            <option value="100">100 per halaman</option>\n                            <option value="0">Semua</option>\n                        </select>\n                    </div>\n                </div>\n\n                <div id="${this.config.containerId}-loading" class="text-center mt-3" style="display: none;">\n                    <div class="spinner-border text-primary" role="status">\n                        <span class="visually-hidden">Loading...</span>\n                    </div>\n                </div>\n            </div>\n\n            ${this.getModalTemplates()}\n        `}getModalTemplates(){return`\n            ${this.config.enableCreate?`\n            <div class="modal fade" id="${this.config.containerId}-createModal" tabindex="-1">\n                <div class="modal-dialog">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title">Tambah Data Baru</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                        </div>\n                        <div class="modal-body">\n                            <form id="${this.config.containerId}-createForm">\n                                <div id="${this.config.containerId}-createFields"></div>\n                            </form>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>\n                            <button type="button" class="btn btn-primary" id="${this.config.containerId}-saveCreate">Simpan</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            `:""}\n\n            <div class="modal fade" id="${this.config.containerId}-detailModal" tabindex="-1">\n                <div class="modal-dialog modal-lg">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title">Detail Data</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                        </div>\n                        <div class="modal-body">\n                            <div class="row" id="${this.config.containerId}-detailFields"></div>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            ${this.config.enableEdit?`\n            <div class="modal fade" id="${this.config.containerId}-editModal" tabindex="-1">\n                <div class="modal-dialog">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title">Edit Data</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                        </div>\n                        <div class="modal-body">\n                            <form id="${this.config.containerId}-editForm">\n                                <div id="${this.config.containerId}-editFields"></div>\n                            </form>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>\n                            <button type="button" class="btn btn-primary" id="${this.config.containerId}-saveEdit">Simpan</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            `:""}\n\n            ${this.config.enableDelete?`\n            <div class="modal fade" id="${this.config.containerId}-deleteModal" tabindex="-1">\n                <div class="modal-dialog">\n                    <div class="modal-content">\n                        <div class="modal-header">\n                            <h5 class="modal-title">Konfirmasi Hapus</h5>\n                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>\n                        </div>\n                        <div class="modal-body">\n                            <p>Apakah Anda yakin ingin menghapus data ini?</p>\n                            <p class="text-danger" id="${this.config.containerId}-deleteMessage">Data yang dihapus tidak dapat dikembalikan.</p>\n                        </div>\n                        <div class="modal-footer">\n                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>\n                            <button type="button" class="btn btn-danger" id="${this.config.containerId}-confirmDelete">Hapus</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            `:""}\n        `}updateTableHeader(){const t=$(`#${this.config.tableId} thead tr`);t.empty(),this.config.enableSelection&&t.append($("<th>").addClass("checkbox-column").append($("<input>").attr("type","checkbox").attr("id",this.config.containerId+"-selectAllCheckbox").addClass("form-check-input"))),this.config.columns.forEach(e=>{if(e.visible){const i=$("<th>").text(e.title);e.sortable&&i.append($("<button>").attr("type","button").addClass("btn btn-sm btn-outline-secondary sort ms-1").attr("id",`${this.config.containerId}-sort-${e.key}`).attr("data-sort",e.key).html("↕")),t.append(i)}})}renderTable(){const t=$(`#${this.config.tableId}-body`);t.empty();const e=this.getCurrentPageData();if(0===e.length)return t.append($("<tr>").append($("<td>").attr("colspan",this.getColumnCount()).addClass("text-center py-4 text-muted").html('<i class="fas fa-inbox me-2"></i>Tidak ada data yang ditemukan'))),void $(`#${this.config.containerId}-selectAllCheckbox`).prop("disabled",!0);$(`#${this.config.containerId}-selectAllCheckbox`).prop("disabled",!1),e.forEach(e=>{const i=this.selectedIds.has(e.id),a=$("<tr>").attr("id",`${this.config.tableId}-row-${e.id}`).toggleClass("selected-row",i);if(this.config.enableSelection){const t=$("<input>").attr("type","checkbox").addClass("form-check-input row-checkbox").attr("id",`${this.config.tableId}-checkbox-${e.id}`).attr("data-item-id",e.id).prop("checked",i).on("change",t=>{const e=$(t.target).data("item-id");this.toggleRowSelection(e,t.target.checked)});a.append($("<td>").addClass("checkbox-column").append(t))}this.config.columns.forEach(t=>{t.visible&&("actions"===t.key?a.append(this.getActionButtons(e)):a.append($("<td>").text(this.getCellValue(e,t.key))))}),t.append(a)}),this.updateSelectAllCheckbox(),this.updatePagination(),this.updateSelectionCount()}getColumnCount(){let t=this.config.columns.filter(t=>t.visible).length;return this.config.enableSelection&&t++,t}getCellValue(t,e){const i=e.split(".");let a=t;for(const t of i)if(a=a?.[t],void 0===a)break;return a||"-"}getActionButtons(t){const e=$("<td>").addClass("action-buttons");return this.config.actions.detail&&e.append($("<button>").html('<i class="fas fa-eye me-1"></i>Detail').addClass("btn btn-info btn-sm btn-action").on("click",()=>this.showDetailModal(t))),this.config.actions.edit&&this.config.enableEdit&&e.append($("<button>").html('<i class="fas fa-edit me-1"></i>Edit').addClass("btn btn-warning btn-sm btn-action").on("click",()=>this.showEditModal(t))),this.config.actions.delete&&this.config.enableDelete&&e.append($("<button>").html('<i class="fas fa-trash me-1"></i>Hapus').addClass("btn btn-danger btn-sm btn-action").on("click",()=>this.showDeleteModal(t))),e}toggleSelectAll(){const t=$(`#${this.config.containerId}-selectAllCheckbox`);$(`#${this.config.tableId} .row-checkbox`);if(this.isSelectAll=t.prop("checked"),this.isSelectAll){this.getCurrentPageData().forEach(t=>{this.selectedIds.add(t.id),$(`#${this.config.tableId}-row-${t.id}`).addClass("selected-row"),$(`#${this.config.tableId}-checkbox-${t.id}`).prop("checked",!0)})}else{this.getCurrentPageData().forEach(t=>{this.selectedIds.delete(t.id),$(`#${this.config.tableId}-row-${t.id}`).removeClass("selected-row"),$(`#${this.config.tableId}-checkbox-${t.id}`).prop("checked",!1)})}this.updateSelectionCount(),this.callbacks.onSelect(Array.from(this.selectedIds))}toggleRowSelection(t,e){e?(this.selectedIds.add(t),$(`#${this.config.tableId}-row-${t}`).addClass("selected-row")):(this.selectedIds.delete(t),$(`#${this.config.tableId}-row-${t}`).removeClass("selected-row"),$(`#${this.config.containerId}-selectAllCheckbox`).prop("checked",!1),this.isSelectAll=!1),this.updateSelectAllCheckbox(),this.updateSelectionCount(),this.callbacks.onSelect(Array.from(this.selectedIds))}updateSelectionCount(){if(!this.config.enableSelection)return;const t=this.selectedIds.size,e=$(`#${this.config.containerId}-selectedCount`);t>0?e.text(t+" data terpilih").show():e.hide()}selectAllVisible(){this.getCurrentPageData().forEach(t=>{this.selectedIds.add(t.id),$(`#${this.config.tableId}-row-${t.id}`).addClass("selected-row"),$(`#${this.config.tableId}-checkbox-${t.id}`).prop("checked",!0)}),this.updateSelectAllCheckbox(),this.updateSelectionCount(),this.callbacks.onSelect(Array.from(this.selectedIds))}deselectAll(){this.selectedIds.clear(),$(`#${this.config.tableId} .selected-row`).removeClass("selected-row"),$(`#${this.config.tableId} .row-checkbox`).prop("checked",!1),$(`#${this.config.containerId}-selectAllCheckbox`).prop("checked",!1),this.isSelectAll=!1,this.updateSelectionCount(),this.callbacks.onSelect([])}updateSelectAllCheckbox(){const t=$(`#${this.config.containerId}-selectAllCheckbox`),e=this.getCurrentPageData();if(0===e.length)return t.prop("checked",!1),void t.prop("disabled",!0);t.prop("disabled",!1);const i=e.every(t=>this.selectedIds.has(t.id));t.prop("checked",i),this.isSelectAll=i}handleSearch(t){if(t){const e=t.toLowerCase();this.filteredData=this.currentData.filter(t=>Object.keys(t).some(i=>{const a=this.getCellValue(t,i);return String(a).toLowerCase().includes(e)}))}else this.filteredData=[...this.currentData];this.currentPage=1,this.updateSelectAllCheckbox(),this.renderTable()}handleSort(t){const e=this.config.columns.find(e=>e.key===t);e&&e.sortable&&(this.currentSortField===t?this.sortDirection="asc"===this.sortDirection?"desc":"asc":(this.currentSortField=t,this.sortDirection="asc"),this.filteredData.sort((e,i)=>{let a=this.getCellValue(e,t),n=this.getCellValue(i,t);"string"==typeof a&&"string"==typeof n&&(a=a.toLowerCase(),n=n.toLowerCase()),null==a&&(a=""),null==n&&(n="");let s=0;return a<n&&(s=-1),a>n&&(s=1),"desc"===this.sortDirection?-s:s}),this.renderTable(),this.updateSortIndicator(t))}updateSortIndicator(t){$(`#${this.config.tableId} .sort`).each((function(){const t=$(this),e=t.text();"↑"!==e&&"↓"!==e||t.text("↕")}));const e=$(`#${this.config.tableId} .sort[data-sort="${t}"]`);e.length&&e.text("asc"===this.sortDirection?"↑":"↓")}getCurrentPageData(){const t=0===this.pageSize?this.filteredData.length:this.pageSize,e=(this.currentPage-1)*t,i=e+t;return this.filteredData.slice(e,i)}updatePagination(){const t=Math.ceil(this.filteredData.length/this.pageSize)||1,e=$(`#${this.config.containerId}-pageInfo`),i=$(`#${this.config.containerId}-prevBtn`),a=$(`#${this.config.containerId}-nextBtn`);e.text(`Halaman ${this.currentPage} dari ${t}`),i.prop("disabled",1===this.currentPage),a.prop("disabled",this.currentPage===t)}showDetailModal(t){this.generateDetailContent(t),$(`#${this.config.containerId}-detailModal`).modal("show")}showEditModal(t){this.currentEditId=t.id,this.generateEditForm(t),$(`#${this.config.containerId}-editModal`).modal("show")}showDeleteModal(t){this.currentDeleteId=t.id,$(`#${this.config.containerId}-deleteModal`).modal("show")}generateDetailContent(t){const e=$(`#${this.config.containerId}-detailFields`);e.empty(),this.config.columns.forEach(i=>{if("actions"!==i.key&&i.visible){const a=this.getCellValue(t,i.key);e.append(`\n                    <div class="col-md-6 mb-3">\n                        <strong>${i.title}:</strong>\n                        <div class="detail-value">${a||"-"}</div>\n                    </div>\n                `)}})}generateEditForm(t){const e=$(`#${this.config.containerId}-editFields`);e.empty(),this.config.columns.forEach(i=>{if("actions"!==i.key&&i.visible&&"id"!==i.key){const a=this.getCellValue(t,i.key),n="edit_"+i.key,s=`\n                    <div class="mb-3">\n                        <label for="${n}" class="form-label">${i.title}</label>\n                        <input type="text" \n                               class="form-control" \n                               id="${n}" \n                               name="${i.key}"\n                               value="${a||""}"\n                               placeholder="Masukkan ${i.title}">\n                    </div>\n                `;e.append(s)}})}async saveEdit(){try{const t={};this.config.columns.forEach(e=>{if("actions"!==e.key&&e.visible&&"id"!==e.key){const i=$(`#${this.config.containerId}-edit_${e.key}`).val();t[e.key]=i}}),await this.updateItem(this.currentEditId,t),$(`#${this.config.containerId}-editModal`).modal("hide")}catch(t){}}async deleteItem(t){try{await this.apiRequest(this.config.apiEndpoints.delete+t,{method:"DELETE"}),this.showNotification("Data berhasil dihapus","success"),this.callbacks.onDelete(t),this.loadData(),$(`#${this.config.containerId}-deleteModal`).modal("hide")}catch(t){this.handleError("Gagal menghapus data",t)}}showCreateModal(){this.generateCreateForm(),$(`#${this.config.containerId}-createModal`).modal("show")}generateCreateForm(){const t=$(`#${this.config.containerId}-createFields`);t.empty(),this.config.columns.forEach(e=>{if("actions"!==e.key&&e.visible&&"id"!==e.key){const i="create_"+e.key,a=`\n                    <div class="mb-3">\n                        <label for="${i}" class="form-label">${e.title}</label>\n                        <input type="text" \n                               class="form-control" \n                               id="${i}" \n                               name="${e.key}"\n                               placeholder="Masukkan ${e.title}">\n                    </div>\n                `;t.append(a)}})}async saveCreate(){try{const t={};this.config.columns.forEach(e=>{if("actions"!==e.key&&e.visible&&"id"!==e.key){const i=$(`#${this.config.containerId}-create_${e.key}`).val();t[e.key]=i}}),await this.createItem(t),$(`#${this.config.containerId}-createModal`).modal("hide")}catch(t){}}async createItem(t){try{const e=await this.apiRequest(this.config.apiEndpoints.create,{method:"POST",body:JSON.stringify(t)});return this.showNotification("Data berhasil ditambahkan","success"),this.callbacks.onCreate(t,e),this.loadData(),e}catch(t){throw this.handleError("Gagal menambahkan data",t),t}}async updateItem(t,e){try{const i=await this.apiRequest(this.config.apiEndpoints.update+t,{method:"PUT",body:JSON.stringify(e)});return this.showNotification("Data berhasil diupdate","success"),this.callbacks.onEdit(t,e,i),this.loadData(),i}catch(t){throw this.handleError("Gagal mengupdate data",t),t}}exportToCSV(t,e="data.csv"){if(t&&0!==t.length)try{let i=this.config.columns.filter(t=>t.visible&&"actions"!==t.key).map(t=>t.title).join(",")+"\n";t.forEach(t=>{const e=this.config.columns.filter(t=>t.visible&&"actions"!==t.key).map(e=>{const i=this.getCellValue(t,e.key);return`"${String(i).replace(/"/g,'""')}"`});i+=e.join(",")+"\n"});const a=new Blob([i],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a"),s=URL.createObjectURL(a);n.setAttribute("href",s),n.setAttribute("download",e),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),this.showNotification("Data berhasil diexport: "+e,"success"),this.callbacks.onExport({format:"csv",data:t,filename:e})}catch(t){console.error("Export CSV error:",t),this.showNotification("Gagal mengexport data","error")}else this.showNotification("Tidak ada data untuk diexport","warning")}exportToExcel(t,e="data.xlsx"){if(t&&0!==t.length)try{const i=t.map(t=>{const e={};return this.config.columns.filter(t=>t.visible&&"actions"!==t.key).forEach(i=>{e[i.title]=this.getCellValue(t,i.key)}),e}),a=XLSX.utils.json_to_sheet(i),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,a,"Data"),XLSX.writeFile(n,e),this.showNotification("Data berhasil diexport: "+e,"success"),this.callbacks.onExport({format:"excel",data:t,filename:e})}catch(t){console.error("Export Excel error:",t),this.showNotification("Gagal mengexport data","error")}else this.showNotification("Tidak ada data untuk diexport","warning")}handleExport(t,e="all"){let i,a;"all"===e||0===this.selectedIds.size?(i=this.currentData,a=`all-data-${(new Date).toISOString().split("T")[0]}.${t}`):(i=this.currentData.filter(t=>this.selectedIds.has(t.id)),a=`selected-data-${(new Date).toISOString().split("T")[0]}.${t}`),"csv"===t?this.exportToCSV(i,a):"xlsx"===t&&this.exportToExcel(i,a)}bindEvents(){const t=`#${this.config.containerId}-`;$(t+"searchInput").on("input",t=>{this.handleSearch(t.target.value)}),$(t+"refreshBtn").on("click",()=>{this.loadData()}),$(t+"pageSize").on("change",t=>{this.pageSize=parseInt(t.target.value),this.currentPage=1,this.renderTable()}),$(t+"prevBtn").on("click",()=>{this.currentPage>1&&(this.currentPage--,this.renderTable())}),$(t+"nextBtn").on("click",()=>{const t=Math.ceil(this.filteredData.length/this.pageSize);this.currentPage<t&&(this.currentPage++,this.renderTable())}),$(document).on("click",t+"sort",t=>{t.preventDefault(),t.stopPropagation();const e=$(t.target).data("sort");e&&this.handleSort(e)}),this.config.enableSelection&&($(document).on("change",t+"selectAllCheckbox",t=>{this.toggleSelectAll()}),$(t+"selectAllBtn").on("click",()=>{this.selectAllVisible()}),$(t+"deselectAllBtn").on("click",()=>{this.deselectAll()})),this.config.enableExport&&$(document).on("click",t+"export-btn",t=>{t.preventDefault();const e=$(t.target).data("format"),i=$(t.target).data("scope");this.handleExport(e,i)}),this.config.enableCreate&&($(t+"createBtn").on("click",()=>{this.showCreateModal()}),$(t+"saveCreate").on("click",()=>{this.saveCreate()})),this.config.enableEdit&&$(t+"saveEdit").on("click",()=>{this.saveEdit()}),this.config.enableDelete&&$(t+"confirmDelete").on("click",()=>{this.currentDeleteId&&this.deleteItem(this.currentDeleteId)})}showLoading(t){const e=$(`#${this.config.containerId}-loading`),i=$("#"+this.config.tableId);t?(e.show(),i.hide()):(e.hide(),i.show())}showNotification(t,e="info"){$(`#${this.config.containerId}-notifications .alert`).each((function(){$(this).text().includes(t)&&$(this).alert("close")}));const i=$(`\n            <div class="alert ${{success:"alert-success",error:"alert-danger",warning:"alert-warning",info:"alert-info"}[e]||"alert-info"} alert-dismissible fade show" role="alert">\n                <i class="fas ${"success"===e?"fa-check-circle":"error"===e?"fa-exclamation-circle":"warning"===e?"fa-exclamation-triangle":"fa-info-circle"} me-2"></i>\n                ${t}\n                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>\n            </div>\n        `);$(`#${this.config.containerId}-notifications`).append(i),setTimeout(()=>{i.length&&i.alert("close")},5e3)}loadExcelLibrary(){if("undefined"==typeof XLSX){const t=document.createElement("script");t.src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js",t.onload=()=>console.log("Excel library loaded"),document.head.appendChild(t)}}reload(){this.loadData()}setData(t){this.currentData=t,this.filteredData=[...t],this.currentPage=1,this.deselectAll(),this.renderTable()}getSelectedData(){return this.currentData.filter(t=>this.selectedIds.has(t.id))}getAllData(){return this.currentData}getFilteredData(){return this.filteredData}updateConfig(t){this.config={...this.config,...t},this.renderTable()}setApiEndpoints(t){this.config.apiEndpoints={...this.config.apiEndpoints,...t}}setRequestHeaders(t){this.config.requestHeaders={...this.config.requestHeaders,...t}}destroy(){["click","input","change"].forEach(t=>{$(document).off(t,`[id^="${this.config.containerId}-"]`)}),$("#"+this.config.containerId).empty(),this.ws&&this.ws.close(),console.log(`TableManager instance for ${this.config.containerId} destroyed`)}}"undefined"!=typeof window&&(window.TableManager=TableManager,"undefined"!=typeof module&&module.exports&&(module.exports=TableManager));
